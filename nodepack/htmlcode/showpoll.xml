<node>
  <type_nodetype>4</type_nodetype>
  <modperlsafe>1</modperlsafe>
  <node_id>2052743</node_id>
  <title>showpoll</title>
  <code>my ($POLL, $showStatus) = @_;
getRef $POLL;
$POLL ||= $NODE;

return &quot;Ack! Can't find poll!&quot; unless $POLL &amp;&amp; $$POLL{type}{title} eq 'e2poll';

my $vote = ($DB-&gt;sqlSelect(
	'choice'
	, 'pollvote'
	, &quot;voter_user=$$USER{node_id} AND pollvote_id=$$POLL{node_id}&quot;
))[0];

$vote = -1 unless defined $vote;

$showStatus = &quot; ($$POLL{poll_status})&quot; if $showStatus;
my $str = undef; $str = '&lt;h2&gt;'.linkNode($POLL).&quot;$showStatus&lt;/h2&gt;&quot;
	unless $$POLL{node_id} == $$NODE{node_id};

$str .= '&lt;p&gt;&lt;cite&gt;by '
	.linkNode($$POLL{poll_author}, '', {-class =&gt; 'author'})
	.'&lt;/cite&gt;';

$str .= $query -&gt; small(' ('.linkNode($POLL, 'edit', {displaytype =&gt; 'edit'}).')')
	if $$POLL{poll_status} eq 'new' &amp;&amp; $query -&gt; param('displaytype') ne 'edit'
		&amp;&amp; canUpdateNode($USER, $POLL);

$str .=	'&lt;/p&gt;&lt;h3&gt;'
	.parseLinks($query -&gt; escapeHTML($$POLL{question})) # question is unsanitised user input...
	.'&lt;/h3&gt;';

my @options = split /\s*\n\s*/s, parseLinks($$POLL{doctext});

unless ($vote &gt; -1 or $$POLL{poll_status} eq 'closed'){
	my @values = ();
	@options = map {(($values[scalar @values] = scalar @values) =&gt; $_)} @options;
	$query-&gt;autoEscape(undef);
	my $buttons = $query-&gt;radio_group(
		-name =&gt; 'vote',
		-values =&gt; \@values,
		-linebreak=&gt;&quot;true&quot;,
		-labels =&gt; {@options}
	);
	$query-&gt;autoEscape(1);
	unless ($$POLL{poll_status} eq 'new'){
		$str .= htmlcode('openform', -class =&gt; 'e2poll')
			.qq'&lt;input type=&quot;hidden&quot; name=&quot;op&quot; value=&quot;pollvote&quot;&gt;
			&lt;input type=&quot;hidden&quot; name=&quot;poll_id&quot; value=&quot;$$POLL{node_id}&quot;&gt;'
			.$buttons
			.htmlcode('closeform', 'vote');
	}else{ # new poll is inactive
		$str .= '&lt;form class=&quot;e2poll&quot;&gt;'
			.$buttons
			.'&lt;/form&gt;'
	}
}else{
	my @results = split ',', $$POLL{e2poll_results};
	my $votedivider = $$POLL{totalvotes}||1;
	$str .= '&lt;table class=&quot;e2poll&quot;&gt;';
	my $i = 0;
	while($options[$i]){
		$str.='&lt;tr&gt;
		&lt;td&gt;'.($i == $vote ? '&lt;b&gt;' : '').$options[$i].($i ==$vote ? '&lt;/b&gt;' : '').'&lt;/td&gt;
		&lt;td align=&quot;right&quot;&gt;&amp;nbsp;'.$results[$i].'&amp;nbsp;&lt;/td&gt;
		&lt;td align=&quot;right&quot;&gt;'.sprintf(&quot;%2.2f&quot;,($results[$i]/$votedivider)*100).'%&lt;/td&gt;
		&lt;/tr&gt;';
		$str.=&quot;&lt;tr&gt;&lt;td colspan='3'&gt;&lt;img class='oddrow' src='http://static.everything2.com/dot.gif'
			height='8' width='&quot;
			.sprintf(&quot;%2.0f&quot;,($results[$i]/$votedivider)*180).&quot;' /&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;
		$i++;
	}
	$str.='&lt;tr&gt;
	&lt;td&gt;&lt;b&gt;Total&lt;/b&gt;&lt;/td&gt;
	&lt;td align=&quot;right&quot;&gt;&amp;nbsp;'.$$POLL{totalvotes}.'&amp;nbsp;&lt;/td&gt;
	&lt;td align=&quot;right&quot;&gt;'.sprintf(&quot;%2.2f&quot;,100).'%&lt;/td&gt;
	&lt;/tr&gt;';
	$str.='&lt;/table&gt;';
}

return $str;
</code>
</node>
